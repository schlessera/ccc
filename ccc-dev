#!/usr/bin/env bash

# Claude Code Central - Development Runner
# Copy this file to ~/bin/ccc to run the development version from anywhere
#
# Usage: ccc [command] [options]
#
# This script assumes the CCC development project is located at:
# ~/bin/ccc/ (adjust CCC_DEV_DIR if your project is elsewhere)

# Configuration - adjust this path to your CCC development directory
CCC_DEV_DIR="$HOME/bin/ccc"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check if development directory exists
if [ ! -d "$CCC_DEV_DIR" ]; then
    echo -e "${RED}❌ CCC development directory not found at: $CCC_DEV_DIR${NC}"
    echo "Please update the CCC_DEV_DIR variable in this script to point to your CCC project."
    exit 1
fi

# Function to check if rebuild is needed
needs_rebuild() {
    if [ ! -d "$CCC_DEV_DIR/dist" ]; then
        return 0  # Need build if dist doesn't exist
    fi
    
    # Check if any TypeScript file is newer than the build
    local newest_src=$(find "$CCC_DEV_DIR/src" -name "*.ts" -type f -exec stat -f "%m" {} \; 2>/dev/null | sort -rn | head -1)
    local newest_dist=$(find "$CCC_DEV_DIR/dist" -name "*.js" -type f -exec stat -f "%m" {} \; 2>/dev/null | sort -rn | head -1)
    
    # If we can't determine timestamps, assume rebuild needed
    if [ -z "$newest_src" ] || [ -z "$newest_dist" ]; then
        # Try Linux stat format if macOS format failed
        newest_src=$(find "$CCC_DEV_DIR/src" -name "*.ts" -type f -exec stat -c "%Y" {} \; 2>/dev/null | sort -rn | head -1)
        newest_dist=$(find "$CCC_DEV_DIR/dist" -name "*.js" -type f -exec stat -c "%Y" {} \; 2>/dev/null | sort -rn | head -1)
    fi
    
    if [ -z "$newest_src" ] || [ -z "$newest_dist" ]; then
        return 0
    fi
    
    [ "$newest_src" -gt "$newest_dist" ]
}

# Check if node_modules exists
if [ ! -d "$CCC_DEV_DIR/node_modules" ]; then
    echo -e "${YELLOW}⚠️  Dependencies not installed. Running npm install...${NC}"
    cd "$CCC_DEV_DIR" && npm install
    if [ $? -ne 0 ]; then
        echo -e "${RED}❌ Failed to install dependencies${NC}"
        exit 1
    fi
fi

# Check if rebuild is needed
if needs_rebuild; then
    echo -e "${YELLOW}⚠️  Source files changed. Rebuilding...${NC}"
    cd "$CCC_DEV_DIR" && npm run build
    if [ $? -ne 0 ]; then
        echo -e "${RED}❌ Build failed${NC}"
        exit 1
    fi
    echo -e "${GREEN}✓ Build successful${NC}"
fi

# Run the CLI with all passed arguments
exec node "$CCC_DEV_DIR/dist/cli/index.js" "$@"